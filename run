#!/usr/bin/env python

# run [--modules] expr10

import subprocess
import sys
import csv
import os
import os.path

_i = 1
if sys.argv[_i] == '--modules':
    _i += 1
    using_modules = True
    modules = {'python3.5':'python35', 'python2.7':'python27', 'python3.6':'python36', 'pypy':'pypy',
               'python3.5-cython':'python35', 'python2.7-cython':'python27', 'python3.6-cython':'python36'}
else:
    using_modules = False
expname = sys.argv[_i]

versions = []

with open('versions/install.csv', 'r') as f:
    reader = csv.reader(f)
    flag = True
    for row in reader:
        if flag:
            header = row
            flag = False
            continue
        versions.append( row )

header += ['Name', 'Replications', 'Min', 'Mean', 'Max', 'Stddev']

os.chdir('benchmarks')

print("Running experiment: %s" % expname)

for row in versions:
    dirname, pyver, release = row
    print("")
    print("Version: %s" % dirname)
    print("")
    if using_modules:
        shstr = """#!/bin/sh
module load %s
../versions/%s/bin/python %s.py %s_%s.csv %s
module unload %s
"""
        with open('run.sh', 'w') as file:
            file.write(shstr % (modules[pyver], dirname, expname, expname, dirname, " ".join(row), modules[pyver]))
        subprocess.run(['/bin/sh', 'run.sh'])
    else:
        subprocess.run([os.path.abspath('../versions/%s/bin/python' % dirname), expname+'.py', "%s_%s.csv" % (expname, dirname)] + row)

#
# Combine benchmark data
#
with open('%s.csv' % expname, 'w') as csvfile:
    writer = csv.writer(csvfile, delimiter=',')
    writer.writerow(header)
    for v in versions:
        dirname, pyver, release = v
        fname = '%s_%s.csv' % (expname, dirname)
        with open(fname, 'r') as csvresults:
            reader = csv.reader(csvresults)
            for row in reader:
                writer.writerow(row)


