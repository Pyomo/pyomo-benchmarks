#!/usr/bin/env python

# run [--modules] expr10

import subprocess
import sys
import csv
import os
import os.path

using_modules = False
test_releases = False
test_branches = False
_i = 1
while sys.argv[_i].startswith('--'):
    if sys.argv[_i] == '--modules':
        using_modules = True
        modules = {'python3.5':'python35', 'python2.7':'python27', 'python3.6':'python36', 'pypy':'pypy',
                   'python3.5-cython':'python35', 'python2.7-cython':'python27', 'python3.6-cython':'python36'}
    elif sys.argv[_i] == '--releases':
        test_releases = True
    elif sys.argv[_i] == '--branches':
        test_branches = True
    _i += 1
expname = sys.argv[_i]

versions = []

if test_releases:
    configfile = 'versions/releases.csv'
elif test_branches:
    configfile = 'versions/branches.csv'
else:
    configfile = 'versions/install.csv'
with open(configfile, 'r') as f:
    reader = csv.reader(f)
    for row in reader:
        versions.append( row )

#header += ['Name', 'Replications', 'Min', 'Mean', 'Max', 'Stddev']

os.chdir('benchmarks')

print("Running experiment: %s" % expname)

for row in versions:
    dirname, pyver, release = row
    if test_releases:
        ofile = "%s_releases.csv" % expname
    elif test_branches:
        ofile = "%s_branches.csv" % expname
    else:
        ofile = "%s_results.csv" % expname
    print("")
    print("Version: %s" % dirname)
    print("")
    if using_modules:
        shstr = """#!/bin/sh
module load %s
../versions/%s/bin/python %s.py %s %s %s
module unload %s
"""
        with open('run.sh', 'w') as file:
            file.write(shstr % (modules[pyver], dirname, expname, ofile, pyver, release, modules[pyver]))
        subprocess.run(['/bin/sh', 'run.sh'])
    else:
        subprocess.run([os.path.abspath('../versions/%s/bin/python' % dirname), expname+'.py', ofile, pyver, release])

